# ๐ OTP Service โ One-Time Password Backend API

## ๐ ะะฟะธัะฐะฝะธะต

ะญัะพ backend-ะฟัะธะปะพะถะตะฝะธะต, ัะตะฐะปะธะทัััะตะต ะณะตะฝะตัะฐัะธั, ะพัะฟัะฐะฒะบั ะธ ะฟัะพะฒะตัะบั ะพะดะฝะพัะฐะทะพะฒัั ะฟะฐัะพะปะตะน (OTP) ะดะปั ะพะฑะตัะฟะตัะตะฝะธั ะดะฒัััะฐะบัะพัะฝะพะน ะฐััะตะฝัะธัะธะบะฐัะธะธ ะธ ะฟะพะดัะฒะตัะถะดะตะฝะธั ะพะฟะตัะฐัะธะน.

ะกะตัะฒะธั ะฟะพะทะฒะพะปัะตั:

- ะะตะณะธัััะฐัะธั ะธ ะฐะฒัะพัะธะทะฐัะธั ั ัะพะบะตะฝะฐะผะธ
- ะะตะฝะตัะฐัะธั ะธ ะฒะฐะปะธะดะฐัะธั ะบะพะดะพะฒ
- ะัะฟัะฐะฒะบะฐ ะบะพะดะพะฒ ัะตัะตะท 4 ะบะฐะฝะฐะปะฐ: **Email** , **SMS (ัะตัะตะท SMPP ัะผัะปััะพั)** , **Telegram** , **ัะพััะฐะฝะตะฝะธะต ะฒ ัะฐะนะป**
- ะะฐัััะพะนะบะฐ ะฟะฐัะฐะผะตััะพะฒ ะบะพะดะฐ ะฐะดะผะธะฝะธัััะฐัะพัะพะผ
- ะะพะปะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ัะพะฑััะธะน

ะะตะฐะปะธะทะพะฒะฐะฝะพ ัะพะณะปะฐัะฝะพ ะขะ ะพั ะบะพะผะฟะฐะฝะธะธ Promo IT.

---

## ๐งฉ ะคัะฝะบัะธะพะฝะฐะป

### โ ะะตะณะธัััะฐัะธั ะธ ะะฒัะพัะธะทะฐัะธั

- `/register` โ ัะตะณะธัััะฐัะธั ะฟะพะปัะทะพะฒะฐัะตะปั (ัะพะปั `ADMIN` ะธะปะธ `USER`)
- `/login` โ ะฟะพะปััะตะฝะธะต ัะพะบะตะฝะฐ ะฐะฒัะพัะธะทะฐัะธะธ

### โ OTP ะะพะดั

- `/user/generate` โ ะณะตะฝะตัะฐัะธั OTP-ะบะพะดะฐ, ะฟัะธะฒัะทะฐะฝะฝะพะณะพ ะบ ะพะฟะตัะฐัะธะธ
- `/user/validate` โ ะฟัะพะฒะตัะบะฐ ะบะพะดะฐ

### โ ะะดะผะธะฝะธัััะธัะพะฒะฐะฝะธะต (ัะพะปัะบะพ ะดะปั ัะพะปะธ `ADMIN`)

- `/admin/config` โ ะฟะพะปััะธัั ะธะปะธ ะพะฑะฝะพะฒะธัั ะดะปะธะฝั ะบะพะดะฐ ะธ ะฒัะตะผั ะถะธะทะฝะธ
- `/admin/users` โ ัะฟะธัะพะบ ะฒัะตั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- `/admin/users/{id}` โ ัะดะฐะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ะตะณะพ ะบะพะดะพะฒ

### โ ะะตัะฐะฝะธะทะผั ะพัะฟัะฐะฒะบะธ ะบะพะดะพะฒ

- Email (ัะตัะตะท JavaMail)
- SMS (ัะตัะตะท SMPP ัะผัะปััะพั SMPPSim)
- Telegram (ัะตัะตะท Bot API)
- ะกะพััะฐะฝะตะฝะธะต ะฒ ัะฐะนะป `otp_codes.log`

---

## โ๏ธ ะขะตัะฝะพะปะพะณะธะธ

| ะะะะะะะะะข                   | ะะกะะะะฌะะะะะะะ                      |
|-----------------------------|------------------------------------|
| **Java 22**                 | ะฏะทัะบ ัะฐะทัะฐะฑะพัะบะธ                    |
| **Maven**                   | ะกะธััะตะผะฐ ัะฑะพัะบะธ                     |
| **PostgreSQL**              | ะฅัะฐะฝะตะฝะธะต ะดะฐะฝะฝัั                    |
| **JDBC**                    | ะะพะดะบะปััะตะฝะธะต ะบ ะะ                   |
| **com.sun.net.httpserver**  | HTTP ัะตัะฒะตั                        |
| **SLF4J + Logback**         | ะะพะณะธัะพะฒะฐะฝะธะต                        |
| **SMPPSim**                 | ะญะผัะปััะพั SMPP ะดะปั ัะตััะธัะพะฒะฐะฝะธั SMS |
| **Telegram Bot API**        | ะัะฟัะฐะฒะบะฐ ะบะพะดะพะฒ ัะตัะตะท Telegram      |
| **Docker, Docker Compose**  | ะะฐะฟััะบ                             |

## ๐๏ธ ะกัััะบัััะฐ ะฑะฐะทั ะดะฐะฝะฝัั

### ะขะฐะฑะปะธัั:

1. **users**

    - id
    - login (ัะฝะธะบะฐะปัะฝัะน)
    - password_hash
    - role (`ADMIN`, `USER`)
2. **otp_config**

    - id
    - code_length
    - expiration_time (ะฒ ัะตะบัะฝะดะฐั)
3. **otp_codes**

    - id
    - user_id
    - operation_id
    - code
    - status (`ACTIVE`, `EXPIRED`, `USED`)
    - created_at
    - expires_at

---

## ๐ ะฃััะฐะฝะพะฒะบะฐ ะธ ะะฐะฟััะบ

### 0. ะะปะพะฝะธัะพะฒะฐัั ัะตะฟะพะทะธัะพัะธะน

```bash
git clone https://github.com/d-dmitriev/MephiOTPService.git
cd MephiOTPService
```

### 1. ะฃััะฐะฝะพะฒะธัะต ะทะฐะฒะธัะธะผะพััะธ

```bash
mvn clean install
```
ะัะธ ะทะฐะฟััะบะต ัะตัะตะท docker ะผะพะถะฝะพ ะฟัะพะฟัััะธัั ััะพั ัะฐะณ.

### 2. ะะฐัััะพะนัะต PostgreSQL

ะกะพะทะดะฐะนัะต ะะ ะธ ะฒัะฟะพะปะฝะธัะต SQL ะธะท ัะฐะนะปะฐ `schema.sql`.
ะัะธ ะทะฐะฟััะบะต ัะตัะตะท docker ะผะพะถะฝะพ ะฟัะพะฟัััะธัั ััะพั ัะฐะณ.

### 3. ะะฐัััะพะนัะต ะบะพะฝัะธะณะธ

ะััะตะดะฐะบัะธััะนัะต ัะปะตะดัััะธะต ัะฐะนะปั ะฒ `src/main/resources/`:

- `application.properties` โ ะฝะฐัััะพะนะบะธ ะะ
- `email.properties` โ ะดะฐะฝะฝัะต ะดะปั ะฟะพััั
- `sms.properties` โ ะฝะฐัััะพะนะบะธ SMPP
- `telegram.properties` โ ัะพะบะตะฝ ะฑะพัะฐ
- `logback.xml` โ ััะพะฒะตะฝั ะปะพะณะณะธัะพะฒะฐะฝะธั

### 4. ะะฐะฟัััะธัะต ะฟัะพะตะบั

ะงะตัะตะท Maven:
```bash
mvn exec:java -Dexec.mainClass="org.example.otp.Main"
```

ะงะตัะตะท IDE:
- ะะฐะฟัััะธัะต ะบะปะฐัั Main.java
- ะฃะฑะตะดะธัะตัั, ััะพ ะฒัะต .properties ะดะพัััะฟะฝั

ะงะตัะตะท Docker:
```bash
docker-compose up -d
```

---

## ๐ ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั API

> ะัะต ะทะฐะฟัะพัั ััะตะฑััั ะทะฐะณะพะปะพะฒะบะฐ `Authorization: Bearer <token>` (ะบัะพะผะต `/login` ะธ `/register`)

### ะะตะณะธัััะฐัะธั

```http
POST /register
Content-Type: application/json

{
  "login": "admin",
  "password": "secret123",
  "role": "ADMIN"
}
```
### ะะพะณะธะฝ

```http
POST /login
Content-Type: application/json

{
  "login": "admin",
  "password": "secret123"
}
```

### ะะตะฝะตัะฐัะธั ะบะพะดะฐ

```http
POST /user/generate
Authorization: Bearer <token>
Content-Type: application/json

{
  "operationId": "op_123",
  "channel": "email",
  "destination": "user@example.com"
}
```
### ะัะพะฒะตัะบะฐ ะบะพะดะฐ

```http
POST /user/validate
Authorization: Bearer <token>
Content-Type: application/json

{
  "operationId": "op_123",
  "code": "123456"
}
```

---

## ๐ ะะพะณะธัะพะฒะฐะฝะธะต

ะะพะณะธ ัะพััะฐะฝััััั:

- ะ ะบะพะฝัะพะปั
- ะ ัะฐะนะป `logs/app.log`

ะัะธะผะตั:

```
2025-05-10 01:53:00 [main] INFO  org.example.otp.Main - HTTP-ัะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั 8080
2025-05-10 01:53:00 [main] INFO  org.example.otp.Main - ะกะตัะฒะตั ัะฐะฑะพัะฐะตั...
```

---

## ๐๏ธ ะะพะฟะพะปะฝะธัะตะปัะฝัะต ะธะฝััััะบัะธะธ

### ะะปั ัะตััะธัะพะฒะฐะฝะธั SMS:

- ะะฐะฟัััะธัะต [SMPPSim](https://github.com/delhee/SMPPSim/releases/tag/3.0.0)
- ะะฑะฝะพะฒะธัะต `sms.properties`

### ะะปั ัะตััะธัะพะฒะฐะฝะธั Telegram:

- ะกะพะทะดะฐะนัะต ะฑะพัะฐ ัะตัะตะท @BotFather
- ะะพะปััะธัะต ัะพะบะตะฝ ะธ chat_id ัะตัะตะท `getUpdates`
- ะะฑะฝะพะฒะธัะต `telegram.properties`

---

## ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
src/
โโโ main/
โ   โโโ java/org.example.otp/
โ   โ   โโโ Main.java
โ   โ   โโโ api/
โ   โ   โ   โโโ AuthHandler.java
โ   โ   โ   โโโ AdminApi.java
โ   โ   โ   โโโ UserApi.java
โ   โ   โโโ service/
โ   โ   โ   โโโ AuthService.java
โ   โ   โ   โโโ OtpService.java
โ   โ   โ   โโโ EmailNotificationService.java
โ   โ   โ   โโโ SmsNotificationService.java
โ   โ   โ   โโโ TelegramNotificationService.java
โ   โ   โ   โโโ FileNotificationService.java
โ   โ   โโโ dao/
โ   โ   โ   โโโ UserDao.java
โ   โ   โ   โโโ OtpConfigDao.java
โ   โ   โ   โโโ OtpCodeDao.java
โ   โ   โโโ model/
โ   โ   โ   โโโ User.java
โ   โ   โ   โโโ OtpConfig.java
โ   โ   โ   โโโ OtpCode.java
โ   โ   โโโ util/
โ   โ   โ   โโโ DbConnection.java
โ   โ   โ   โโโ PasswordHasher.java
โ   โ   โ   โโโ TokenUtil.java
โ   โ   โโโ handler/
โ   โ   โ   โโโ LoggingHandler.java
โ   โ   โ   โโโ AuthFilter.java
โ   โ   โโโ scheduler/
โ   โ       โโโ OtpExpiryScheduler.java
โ   โ
โ   โโโ resources/
โ       โโโ application.properties
โ       โโโ email.properties
โ       โโโ sms.properties
โ       โโโ telegram.properties
โ       โโโ logback.xml
โ       โโโ schema.sql
```

---

## ๐ ะะฐะบ ะฟัะพะฒะตัะธัั ัะฐะฑะพัั

### ะะปั Email:

- ะฃะฑะตะดะธัะตัั, ััะพ `email.properties` ัะพะดะตัะถะธั ะฟัะฐะฒะธะปัะฝัะต ััะตัะฝัะต ะดะฐะฝะฝัะต
- ะัะทะพะฒะธัะต `/user/generate` ั `channel=email` ะธ ะฟัะพะฒะตัััะต ะฟะพััั

### ะะปั SMS:

- ะะฐะฟัััะธัะต SMPPSim:
```bash
./startsmppsim.sh
```

### ะะปั Telegram:

- ะะฐะฟัััะธัะต ะฑะพัะฐ ัะตัะตะท @BotFather
- ะะพะปััะธัะต `chat_id` ัะตัะตะท `getUpdates`
- ะัะฟัะฐะฒััะต ะทะฐะฟัะพั ั `channel=telegram`

### ะะปั ัะฐะนะปะฐ:

- ะะพะดั ะฑัะดัั ัะพััะฐะฝััััั ะฒ `otp_codes.log`

---

## ๐ ะะปะฐะฝะธัะพะฒัะธะบ ะธัััะบัะธั ะบะพะดะพะฒ

- ะะฐะถะดัั ะผะธะฝััั ะฟะพะผะตัะฐะตั ัััะฐัะตะฒัะธะต ะบะพะดั ะบะฐะบ `EXPIRED`
- ะัะฟะพะปัะทัะตััั `OtpExpiryScheduler` ั `TimerTask`

---

## ๐ Postman Collection ะฒ ะบะฐัะฐะปะพะณะต docs

ะะพัะปะต ะธะผะฟะพััะฐ ะฒ Postman ะฒั ะผะพะถะตัะต ะธัะฟะพะปัะทะพะฒะฐัั ะบะพะปะปะตะบัะธั ะดะปั:

- ะะตะณะธัััะฐัะธะธ ะธ ะฒัะพะดะฐ
- ะะตะฝะตัะฐัะธะธ ะบะพะดะฐ ัะตัะตะท 4 ะบะฐะฝะฐะปะฐ
- ะัะพะฒะตัะบะธ ะบะพะดะฐ
- ะฃะฟัะฐะฒะปะตะฝะธั ะบะพะฝัะธะณััะฐัะธะตะน ะธ ะฟะพะปัะทะพะฒะฐัะตะปัะผะธ

---

## ๐ ะะปะฐะฝั ะฟะพ ัะปัััะตะฝะธั

- ะะฝัะตะณัะฐัะธั ั Redis ะดะปั ััะฐะฝะตะฝะธั ะฒัะตะผะตะฝะฝัั ะบะพะดะพะฒ
- ะะตะฐะปะธะทะฐัะธั TOTP ะฒะผะตััะพ HOTP
- ะะพะฑะฐะฒะปะตะฝะธะต Swagger UI ะดะปั ะดะพะบัะผะตะฝัะฐัะธะธ API
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต Spring Boot (ะดะปั ะฟัะพะดะฒะธะฝัััั ะฒะตััะธะน)
- ะะตัะฐะฝะธะทะผ ะฟะพะฒัะพัะฝะพะน ะพัะฟัะฐะฒะบะธ ะบะพะดะฐ
- Webhook-ัะฒะตะดะพะผะปะตะฝะธั ะฟัะธ ััะฟะตัะฝะพะผ/ะฝะตััะฟะตัะฝะพะผ ะฟะพะดัะฒะตัะถะดะตะฝะธะธ